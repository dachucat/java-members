<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="course.linkflower.link.oneframework.members.dao.TopicMapper">
    <select id="getTopicById" resultType="course.linkflower.link.oneframework.members.vo.topic.TopicVo">
        select * from topic where id=#{id}
    </select>

    <select id="countByCode" resultType="int">
        select count(*) from topic where code = #{code}
    </select>

    <select id="countByCodeAndId" resultType="int">
        select count(*) from topic where code = #{code} and id != #{id}
    </select>

    <insert id="save" parameterType="course.linkflower.link.oneframework.members.model.Topic" useGeneratedKeys="true" keyProperty="id">
        insert into topic(name, parent_id, parent1_id, column_type, is_hot, icon, sort_value)
        values(#{name},#{parentId},#{parent1Id},#{columnType},#{isHot},#{icon},#{sortValue})
    </insert>

    <delete id="deleteById">
        delete from topic where id=#{id}
    </delete>

    <update id="update" parameterType="course.linkflower.link.oneframework.members.dto.topic.UpdateDto" useGeneratedKeys="true" keyProperty="id">
        update topic where id=#{id} set name=#{name}, parent_id=#{parentId}, column_type=#{columnType}, is_hot=#{isHot},icon=#{icon}, sort_value=#{sortValue}
    </update>
    <select id="listTopicTreeByParentCode" resultType="course.linkflower.link.oneframework.members.vo.topic.TopicTreeVo">
        SELECT
        ID.level,
        DATA.*
        FROM
        (SELECT
        @ids AS _ids,
        (SELECT
        @ids := GROUP_CONCAT(id)
        FROM
        topic
        WHERE FIND_IN_SET(parent_id, @ids)) AS cids,
        @l := @l + 1 AS LEVEL
        FROM
        topic,
        (SELECT
        @ids := (select id from topic where code = #{code}),
        @l := 0) b
        WHERE @ids IS NOT NULL) id,
        topic DATA
        WHERE FIND_IN_SET(DATA.id, ID._ids)
        ORDER BY LEVEL,
        id ;
    </select>
</mapper>